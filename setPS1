#!/bin/env bash

BASE=/opt/qiyunhu
rcfile=$BASE/.qyh_vim/vimrc
export PROXY_HOST=172.20.134.137
PROXY_PORT=2333

main( ) {
    set_working_dir "$@"
    set_PS1
    set_vim_
    set_proxy
    #clean_proxy
    set_vimrc
    set_PATH
    show_banner
}

set_working_dir( ) {
    COMPILER_BASE=$BASE
    PROJECT_NAME=proj/PD1515BA
    LIB_LOG_FILE=compile_lib.log
    if [ -z "$1" ] ; then
        export PROJECT_NAME=$PROJECT_NAME
    else
        export PROJECT_NAME=$1
    fi
    export llf=$COMPILER_BASE/$PROJECT_NAME/$LIB_LOG_FILE
    export w=$COMPILER_BASE/$PROJECT_NAME
    if [ -d "$w/vendor/qcom" ] ; then
        # echo "qcom"
        export w1=$w/vendor/qcom/proprietary/mm-camera/
        export w11=$w1/mm-camera2/media-controller/modules/sensors/
        export w111=$w11/sensor/libs/imx298/
        export w2=$COMPILER_BASE/$PROJECT_NAME/hardware/qcom/camera
    fi
    if [ -d "$w/vendor/mediatek" ] ; then
        # echo "mtk"
        export w1=$w/vendor/mediatek/proprietary/platform/mt6752/hardware/mtkcam/core/featureio/pipe/aaa
    fi
    export w0=$COMPILER_BASE/tools
}

set_PS1( ) {
    PS1="\[\e]0;\w\a\]\n\[\e[32m\]\u@\h \[\e[33m\]\w\[\e[0m\]\n\$ "
}

set_vim_( ) {
    alias vim_="vim -u $rcfile"
}

set_proxy( ) {
    export http_proxy=$PROXY_HOST:$PROXY_PORT
    export https_proxy=$PROXY_HOST:$PROXY_PORT
}

clean_proxy( ) {
    export http_proxy=
    export https_proxy=
}

set_vimrc( ) {
    tmpfile=~/tmp.tmp.tmp.tmp
    flag_start="\" \[+\] generated by setPS1 start"
    flag_end="\" \[+\] generated by setPS1 end"
    line_start=$( grep -n "$flag_start" $rcfile | awk -F ":" '{print $1}' )
    line_end=$( grep -n "$flag_end" $rcfile | awk -F ":" '{print $1}' )
    cmd_1="set tags=$w1/tags,$w/kernel/tags,$w2/tags"
    cmd_2="cs add $w1 $w1"
    cmd_3="cs add $w/kernel $w/kernel"
    cmd_4="cs add $w2 $w2"
    if [ "x$line_start" != "x" ] ; then
        arg_sed="${line_start},${line_end}d"
        sed $arg_sed $rcfile > $tmpfile
    else
        cat $rcfile > $tmpfile
    fi
    echo ${flag_start//\\/} >> $tmpfile
    echo $cmd_1 >> $tmpfile
    echo $cmd_2 >> $tmpfile
    echo $cmd_3 >> $tmpfile
    echo $cmd_4 >> $tmpfile
    echo ${flag_end//\\/} >> $tmpfile
    mv -f $tmpfile $rcfile
}

set_PATH( ) {
    export PATH=$PATH:$BASE/tools
}

show_banner( ) {
    clear
    cat $BASE/tools/banner.txt
}

main "$@"